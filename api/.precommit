#!/bin/sh

echo "Info: Runnning linter and formatter"

gopackages=$(git diff --cached --name-only --diff-filter=ACM | grep '.go$'| xargs -n1 dirname| sort -u| sed 's/^/.\//' )
[ -z "$gopackages" ] && exit 0

echo "Info: git diff(package)"
echo $gopackages
echo "Info: Runnning go vet"
linterr="$(go vet $gopackages 2>&1 )"
if [ -n "$linterr" ] ; then
    echo "fatal:"
    echo $linterr
    exit 1
fi

echo "Info: go vet    --- OK"

unformatted=$(goimports -l $gopackages 2>&1 )
if [ -n "$unformatted" ] ; then
    echo "Info: unformatted file detected"
    echo "Info: $unformatted"
    echo "Info: Running goimports."
    for fn in $unformatted; do
        goimports -w $fn
        echo >&2 "goimports -w $fn"
        git add $fn
    done
fi

echo "Info: goinports --- OK"

exit 0
